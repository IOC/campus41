YUI.add("moodle-atto_snippet-button",function(e,t){function i(e,t){for(var i=0,n=0;n<e.length;n++){var a=e[n].get("title");a.localeCompare(t)<0&&(i+=1)}return i}function n(){o=JSON.parse(window.localStorage.getItem("iedib-atto-snippets")||'{"valors":{}}')}function a(){window.localStorage.setItem("iedib-atto-snippets",JSON.stringify(o))}function s(e,t){return console.log(o),"$"==e.substring(0,1)&&null!=o.valors[e]?o.valors[e]:t}function l(e){for(var t=[],i=0,n=0;n<e.length;n++){var a=e[n];if("#each "===a.substring(0,6)){var s=a.replace("#each ","").trim();t.indexOf(s)<0&&(t[i]=s,i+=1)}else if("#times "===a.substring(0,7)){s=a.replace("#times ","").trim();t.indexOf(s)<0&&(t[i]=s,i+=1)}else if("#ifCond "===a.substring(0,8)){s=a.replace("#ifCond ","").split(" ")[0].trim();t.indexOf(s)<0&&(t[i]=s,i+=1)}else if("../"==a.substring(0,3)){var l=a.lastIndexOf("/");a=a.substring(l+1),t.indexOf(a)<0&&(t[i]=a,i+=1)}else"@"!=a[0]&&"/"!=a[0]&&"#"!=a[0]&&"this"!=a&&"else"!=a&&"math "!=a.substring(0,5)&&t.indexOf(a)<0&&(t[i]=a,i+=1)}return t}function r(e){e=e||"";var t=e.indexOf("|");return t>0&&(e=e.substring(0,t)),e}e.Handlebars&&(e.Handlebars.registerHelper("times",function(e,t){for(var i="",n=0;n<e;++n)t.data.index=n,t.data.first=0===n,t.data.last=n===e-1,i+=t.fn(this);return i}),e.Handlebars.registerHelper("ifCond",function(e,t,i,n){var a;return a="=="==t||"eq"==t?e==i:"<"==t||"lt"==t?e<i:">"==t||"gt"==t?e>i:"<="==t||"leq"==t?e<=i:">="==t||"geq"==t?e>=i:e!=i,a?n.fn(this):n.inverse(this)}),e.Handlebars.registerHelper("math",function(e,t,i,n){return e=parseFloat(e),i=parseFloat(i),{"+":e+i,"-":e-i,"*":e*i,"/":e/i,"%":e%i}[t]}));var o={valors:{}},d=["darkblue","orange","darkred","darkgreen","brown","crimson","purple"],p="atto_snippet",c={INPUTSUBMIT:"atto_media_urlentrysubmit",INPUTCANCEL:"atto_media_urlentrycancel",KEYBUTTON:"atto_snippet_snippetbutton",HEADERTEXT:"atto_snippet_headertext",INSTRUCTIONSTEXT:"atto_snippet_instructionstext",TEMPLATEVARIABLE:"atto_snippet_snippetvariable",CATEGORY_LATERAL:"atto_snippet_lateral",CATEGORY_TITLE:"atto_snippet_title"},u='<div id="{{elementid}}_{{innerform}}" style="text-align:justify"><h4 class="'+c.HEADERTEXT+'">{{headertext}} {{snippetname}}</h4><div class="'+c.INSTRUCTIONSTEXT+'">{{instructions}}</div></div><hr style="margin:0">',g='<div style="border: 2px solid {{color}};margin:2px;width:98%;display:table"><div class="'+c.CATEGORY_LATERAL+'" style="background:{{color}} !important;"><p class="'+c.CATEGORY_TITLE+'">{{categorytext}}</p></div>',v='<div style="display: table-cell;column-count:2;padding-top:5px"></div>',h='<div id="{{elementid}}_{{innerform}}" class="mdl-align"></div>',f='<div id="{{elementid}}_{{innerform}}" class="atto_snippet_buttons mdl-align" style="width:99%;margin:0;"><button style="width:95%" class="atto_snippet_btn '+c.KEYBUTTON+'_{{snippetindex}}">{{#if snippetimage}} <img style="width:30px;" src="{{snippetimage}}"/> {{/if}} {{snippetname}}</button></div>',m='<div id="{{elementid}}_{{innerform}}" style="display:table;width:96%;"><span style="font-weight:bold;display:table-cell;">{{snippetvar}}&nbsp;&nbsp;</span><span style="display:table-cell;"><input type="text" style="width:99%;" class="'+c.TEMPLATEVARIABLE+'_{{variableindex}}" value="{{defaultvalue}}"></input></span></div>',b='<div id="{{elementid}}_{{innerform}}" style="display:table;width:96%;"><span style="font-weight:bold; display:table-cell;">{{snippetvar}}&nbsp;&nbsp;</span><span style="display:table-cell;"><input type="checkbox" class="'+c.TEMPLATEVARIABLE+"_{{variableindex}}\" value=\"{{defaultvalue}}\" {{#ifCond defaultvalue 'eq' '1'}}checked{{/ifCond}}></input></span></div>",_='<div id="{{elementid}}_{{innerform}}"><span style="font-weight:bold;">{{variable}}&nbsp;&nbsp;</span></div>',x='<select class="'+c.TEMPLATEVARIABLE+'_{{variableindex}} atto_snippet_field"></select>',T='<option value="{{option}}">{{optionLabel}}</option>',y='<form class="atto_form"><div id="{{elementid}}_{{innerform}}" class="mdl-align"><button class="'+c.INPUTSUBMIT+'">{{inserttext}}</button></div></form>';e.namespace("M.atto_snippet").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,initializer:function(){if(!this.get("disabled")){var e="iconone";this.addButton({icon:"ed/"+e,iconComponent:"atto_snippet",buttonName:e,callback:this._displayDialogue,callbackArgs:e})}},_displayDialogue:function(t,n){t.preventDefault();var a=550,s=this.getDialogue({headerContent:M.util.get_string("dialogtitle",p),width:a+"px",focusAfterHide:n});s.width!==a+"px"&&s.set("width",a+"px");var l=e.Node.create('<div style="max-height:420px;overflow:auto;"></div>'),r=e.Handlebars.compile(h),o=e.Node.create(r({headertext:M.util.get_string("chooseinsert",p)}));l.append(o);var c=this._getButtonsForSnippets(n),u={altres:[]};e.Array.each(c,function(e){var t=e.one("button"),n=t.get("innerHTML");if(n.indexOf("|")>-1){var a=n.split("|"),s=(a[0]||"").trim(),l=(a[1]||"").trim(),r=u[l];e.set("title",s),t.set("innerHTML",s),r||(r=[],u[l]=r);var o=i(r,s);r.splice(o,0,e)}else{e.set("title",n);r=u.altres,o=i(r,n);r.splice(o,0,e)}});var f=0,m=e.Object.keys(u);m=m.sort(),e.Array.each(m,function(t){var i=u[t],n=d[f%d.length];f+=1;var a=e.Handlebars.compile(g),s=e.Node.create(a({color:n,categorytext:t}));a=e.Handlebars.compile(v);var r=e.Node.create(a({}));s.append(r),l.append(s),e.Array.each(i,function(e){r.append(e)},l)}),s.set("bodyContent",l),s.show(),this.markUpdated()},_showSnippetForm:function(t,i){t.preventDefault();var n=500,a=this.getDialogue({headerContent:M.util.get_string("dialogtitle",p),width:n+"px"});a.width!==n+"px"&&a.set("width",n+"px");var s=this._getSnippetFields(i),l=this.get("instructions")[i];if(l=decodeURIComponent(l),s&&s.length>0)var o=M.util.get_string("fieldsheader",p);else o=M.util.get_string("nofieldsheader",p);var d=e.Handlebars.compile(u),c=e.Node.create(d({snippetname:r(this.get("snippetnames")[i]),headertext:o,instructions:l})),g=c,v=e.Node.create("<div></div>");v.append(g),e.Array.each(s,function(e){v.append(e)},v);var h=this._getSubmitButtons(i);v.append(h),a.set("bodyContent",v),a.show(),this.markUpdated()},_getSubmitButtons:function(t){var i=e.Handlebars.compile(y),n=e.Node.create(i({elementid:this.get("host").get("elementid"),inserttext:M.util.get_string("insert",p)}));return n.one("."+c.INPUTSUBMIT).on("click",this._doInsert,this,t),n},_getSnippetFields:function(t){n();var i=[],a=this.get("snippetvars")[t],r=this.get("defaults")[t],o=r,d=l(a);return e.Array.each(d,function(t,n){if(t in o&&o[t].indexOf("|")>-1){var a=o[t].split("|");if(2===a.length&&a.indexOf("1")>-1&&a.indexOf("0")>-1){var l=e.Handlebars.compile(b);h=e.Node.create(l({elementid:this.get("host").get("elementid"),snippetvar:t,defaultvalue:s(t,a[0]),variableindex:n}))}else{var r=e.Handlebars.compile(_);h=e.Node.create(r({elementid:this.get("host").get("elementid"),variable:t,defaultvalue:s(t,o[t]),variableindex:n}));var d,p=e.Handlebars.compile(x),c=s(t,o[t]),u=e.Node.create(p({variable:t,defaultvalue:c,variableindex:n})),g=e.Handlebars.compile(T);e.Array.each(a,function(t,i){var n=t,a=t;if(t.indexOf(":")>0){var s=t.split(":");n=(s[0]||"").trim(),a=(s[1]||"").trim()}var l=e.Node.create(g({option:n,optionLabel:a}));u.appendChild(l),n==c&&(d=l)}),h.appendChild(u),d&&d.set("selected","true")}}else{var v=o[t];"$RND"===v&&(v=Math.random().toString(32).substring(2));l=e.Handlebars.compile(m);var h=e.Node.create(l({elementid:this.get("host").get("elementid"),snippetvar:t,defaultvalue:s(t,v),variableindex:n}))}i.push(h)},this),i},_getButtonsForSnippets:function(t){var i=[];return e.Array.each(this.get("snippetnames"),function(t,n){var a=e.Handlebars.compile(f),s=e.Node.create(a({elementid:this.get("host").get("elementid"),snippetname:t,snippetindex:n}));this._form=s,s.one("."+c.KEYBUTTON+"_"+n).on("click",this._showSnippetForm,this,n),i.push(s)},this),i},_doInsert:function(t,i){t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide();var n="",s=this.get("snippets")[i],r=(this.get("snippetnames")[i],this.get("snippetvars")[i]),d=l(r),p={};e.Array.each(d,function(t,i){var n=e.one("."+c.TEMPLATEVARIABLE+"_"+i);if(n){var a,s=n.get("type");if("checkbox"==s)a=1==n.get("checked");else if(a=n.get("value"),a=(a+""||"").trim(),0==a.indexOf("[")||a.lastIndexOf("]")==a.length-1)try{a=a.substring(1,a.length-1).split(";");for(var l=0;l<a.length;l++){var r=a[l];r.trim&&(a[l]=r.trim())}}catch(e){console.log(e)}p[t]=a,"$"==t.substring(0,1)&&(o.valors[t]=a)}},this),s=s.replace(/<script/gi,"<!--<script").replace(/<\/script>/gi,"</script>-->"),console.log("> Template before compilation: "),console.log(s);var u=e.Handlebars.compile(s);console.log("> Interpolation variables: "),console.log(p);n=u(p);n=n.replace(/<!--<script/gi,"<script").replace(/<\/script>-->/gi,"</script>"),console.log("> Resulting html content:"),console.log(n),this.editor.focus(),this.get("host").insertContentAtFocusPoint(n),this.markUpdated(),a()}},{ATTRS:{disabled:{value:!1},snippets:{value:null},snippetnames:{value:null},snippetvars:{value:null},defaults:{value:null},instructions:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});